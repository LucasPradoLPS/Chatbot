# ğŸ“Š Diagrama Visual: ValidaÃ§Ã£o Contextual

## Fluxo Completo da SoluÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENTE ENVIA MENSAGEM                       â”‚
â”‚                          "Casa"                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ProcessWhatsappMessage::handle()                    â”‚
â”‚                                                                      â”‚
â”‚  1. Extrai: estadoAtual = "STATE_Q2_TIPO"                          â”‚
â”‚  2. Extrai: mensagem = "Casa"                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             DetecÃ§Ã£o Tradicional de IntenÃ§Ã£o (Falha)               â”‚
â”‚                                                                      â”‚
â”‚  IntentDetector::detect("Casa")                                    â”‚
â”‚       â†“                                                             â”‚
â”‚  Procura em palavra-chaves predefinidas...                         â”‚
â”‚  "oi", "olÃ¡", "comprar", "alugar", "vender", etc.                 â”‚
â”‚       â†“                                                             â”‚
â”‚  âŒ "Casa" nÃ£o estÃ¡ na lista                                       â”‚
â”‚       â†“                                                             â”‚
â”‚  intent = "indefinido"  (SEM CONTEXTO)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                         â”‚
        â†“                                         â†“
   âŒ ANTES (Erro)                      âœ… AGORA (Fix - Novo!)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ intent = "indefinido"   â”‚     â”‚ ContextualResponseValidator â”‚
   â”‚        â†“                â”‚     â”‚ ::validate()              â”‚
   â”‚ IA confusa              â”‚     â”‚                          â”‚
   â”‚        â†“                â”‚     â”‚ Valida:                 â”‚
   â”‚ "NÃ£o entendi certinho"  â”‚     â”‚ Estado: STATE_Q2_TIPO   â”‚
   â”‚        â†“                â”‚     â”‚ OpÃ§Ãµes: [apartamento,   â”‚
   â”‚ âŒ Fluxo quebrado       â”‚     â”‚ casa, kitnet, ...]      â”‚
   â”‚                         â”‚     â”‚        â†“                â”‚
   â”‚                         â”‚     â”‚ Match encontrado? SIM!  â”‚
   â”‚                         â”‚     â”‚        â†“                â”‚
   â”‚                         â”‚     â”‚ âœ… Ã©_vÃ¡lida = true      â”‚
   â”‚                         â”‚     â”‚ intent = "qualif...     â”‚
   â”‚                         â”‚     â”‚ slot = "Casa"           â”‚
   â”‚                         â”‚     â”‚        â†“                â”‚
   â”‚                         â”‚     â”‚ IA informada corretamente â”‚
   â”‚                         â”‚     â”‚        â†“                â”‚
   â”‚                         â”‚     â”‚ "Perfeito! Casa..."     â”‚
   â”‚                         â”‚     â”‚        â†“                â”‚
   â”‚                         â”‚     â”‚ âœ… Fluxo continua      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ãrvore de DecisÃ£o da ValidaÃ§Ã£o

```
                    Mensagem: "Casa"
                    Estado: STATE_Q2_TIPO
                           â”‚
                           â†“
            Existe validaÃ§Ã£o para STATE_Q2_TIPO?
                      â”‚              â”‚
                     SIM            NÃƒO
                      â†“              â†“
            OpÃ§Ãµes esperadas:  Retorna
            [apartamento,      Ã©_vÃ¡lida=null
             casa,            (sem erro)
             kitnet,
             comercial,
             terreno]
                      â”‚
                      â†“
            "casa" estÃ¡ nas opÃ§Ãµes?
                      â”‚
                    SIM
                      â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ValidaÃ§Ã£o PASSOU âœ…      â”‚
            â”‚                         â”‚
            â”‚ Ã©_vÃ¡lida: true          â”‚
            â”‚ intent_sugerida: qualf  â”‚
            â”‚ slot: tipo_imovel       â”‚
            â”‚ valor: "Casa"           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
            Atualiza:
            - intent = "qualificacao_tipo_imovel"
            - slots["tipo_imovel"] = "Casa"
                      â”‚
                      â†“
            IA processa com contexto correto
                      â”‚
                      â†“
            "Perfeito! Casa Ã© Ã³tima..."
```

## ComparaÃ§Ã£o Lado a Lado

### âŒ ANTES: Sem ValidaÃ§Ã£o Contextual

```
Cliente                         Bot                       Estado
  â”‚                             â”‚                           â”‚
  â”‚â”€â”€ "Casa" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚                           â”‚
  â”‚                             â”‚ Recebe msg                â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ IntentDetector:           â”‚
  â”‚                             â”‚ "Casa" â†’ "indefinido"     â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ Prompt para IA:           â”‚
  â”‚                             â”‚ intent=indefinido         â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ IA confusa, responde:     â”‚
  â”‚                      â†â”€â”€â”€â”€  â”‚ "NÃ£o entendi certinho"    â”‚
  â”‚ "?? Mas disse casa..."      â”‚                           â”‚
  â”‚                             â”‚ Fluxo parado              â”‚
```

### âœ… AGORA: Com ValidaÃ§Ã£o Contextual

```
Cliente                         Bot                       Estado
  â”‚                             â”‚                           â”‚
  â”‚â”€â”€ "Casa" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚                           â”‚
  â”‚                             â”‚ Recebe msg                â”‚
  â”‚                             â”‚ Estado = STATE_Q2_TIPO    â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ ContextualValidator:      â”‚
  â”‚                             â”‚ "Casa" Ã© opÃ§Ã£o vÃ¡lida? âœ“  â”‚
  â”‚                             â”‚ intent="qualificacao..."  â”‚
  â”‚                             â”‚ tipo_imovel="Casa"        â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ Prompt para IA:           â”‚
  â”‚                             â”‚ intent=qualificacao...    â”‚
  â”‚                             â”‚ slots={tipo_imovel:Casa}  â”‚
  â”‚                             â”‚                           â”‚
  â”‚                             â”‚ IA bem informada:         â”‚
  â”‚                      â†â”€â”€â”€â”€  â”‚ "Perfeito! Casa Ã© Ã³tima"  â”‚
  â”‚ "Legal! PrÃ³ximo...?"        â”‚                           â”‚
  â”‚                             â”‚ Fluxo continua âœ“          â”‚
```

## MÃ¡quina de Estados Contextualizada

```
                    STATE_START
                        â”‚
                        â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Detecta: OlÃ¡  â”‚
                â”‚ Context-aware â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
                   STATE_LGPD
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Pergunta: Consentimento? â”‚
         â”‚ OpÃ§Ãµes: [Sim, NÃ£o, ...]  â”‚ â† Validadas
         â”‚ Estado: STATE_LGPD       â”‚   contextualmente
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         Resposta: "Sim"
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
                â†“ (vÃ¡lida)              â†“ (invÃ¡lida)
          STATE_OBJETIVO            Repete STATE_LGPD
         [pergunta opcÃµes]          com mensagem de ajuda
                â”‚
                â†“
              ... continua fluxo
```

## Mapas de ValidaÃ§Ã£o por Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE_Q2_TIPO                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pergunta: "Qual tipo de imÃ³vel?"                                â”‚
â”‚                                                                  â”‚
â”‚ OpÃ§Ãµes VÃ¡lidas:                                                 â”‚
â”‚  âœ… apartamento / apartamento / apto / apt                       â”‚
â”‚  âœ… casa / residÃªncia                                            â”‚
â”‚  âœ… kitnet / kitchenette / kit                                   â”‚
â”‚  âœ… comercial / sala comercial                                   â”‚
â”‚  âœ… terreno / lote / terreno                                     â”‚
â”‚                                                                  â”‚
â”‚ NormalizaÃ§Ã£o AutomÃ¡tica:                                        â”‚
â”‚  "CASA"    â†’ "casa"      (maiÃºsculas)                           â”‚
â”‚  "  apt  " â†’ "apt"       (espaÃ§os)                              â”‚
â”‚  "Apt"     â†’ "apt"       (capitalizaÃ§Ã£o)                        â”‚
â”‚                                                                  â”‚
â”‚ Intent Sugerida: qualificacao_tipo_imovel                      â”‚
â”‚ Slot Atualizado: tipo_imovel = "Casa"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE_PROPOSTA                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pergunta: "Como prefere pagar?"                                 â”‚
â”‚                                                                  â”‚
â”‚ OpÃ§Ãµes VÃ¡lidas:                                                 â”‚
â”‚  âœ… Ã  vista / a vista                                            â”‚
â”‚  âœ… financiamento                                                â”‚
â”‚  âœ… parcelado / parcelada                                        â”‚
â”‚  âœ… consÃ³rcio / consorciado                                      â”‚
â”‚  âœ… fgts / com fgts                                              â”‚
â”‚  âœ… permuta / fazer permuta                                      â”‚
â”‚  âœ… misto / combinado                                            â”‚
â”‚                                                                  â”‚
â”‚ Intent Sugerida: resposta_forma_pagamento                      â”‚
â”‚ Slot Atualizado: forma_pagamento = "Financiamento"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE_LGPD                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pergunta: "Aceita compartilhar dados?"                          â”‚
â”‚                                                                  â”‚
â”‚ OpÃ§Ãµes VÃ¡lidas:                                                 â”‚
â”‚  âœ… sim / sim senhor / claro / claro que sim / ok / okay       â”‚
â”‚  âœ… nÃ£o / nao / de jeito nenhum / negativo                     â”‚
â”‚  âœ… concordo / concordo plenamente                              â”‚
â”‚  âœ… aceito / aceito os termos                                   â”‚
â”‚                                                                  â”‚
â”‚ Intent Sugerida: resposta_binaria                              â”‚
â”‚ Slot Atualizado: lgpd_consentimento = "Sim"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Fluxo de Dados Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ENTRADA                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Webhook WhatsApp:                                                   â”‚
â”‚ {                                                                   â”‚
â”‚   "data": {                                                         â”‚
â”‚     "message": {"conversation": "Casa"}  â† Mensagem do usuÃ¡rio   â”‚
â”‚   }                                                                 â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PROCESSAMENTO INICIAL                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ $mensagem = "Casa"                                                  â”‚
â”‚ $estadoAtual = Thread.estado_atual = "STATE_Q2_TIPO"               â”‚
â”‚ $slotsAtuais = {                                                    â”‚
â”‚   "nome": "Lucas",                                                  â”‚
â”‚   "tipo_imovel": null  â† Esperando preencher                       â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. VALIDAÃ‡ÃƒO CONTEXTUAL                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ContextualResponseValidator::validate(                             â”‚
â”‚   "STATE_Q2_TIPO",                                                  â”‚
â”‚   "Casa"                                                            â”‚
â”‚ ) â†’ Retorna:                                                        â”‚
â”‚ {                                                                   â”‚
â”‚   "Ã©_vÃ¡lida": true,                                                â”‚
â”‚   "intent_sugerida": "qualificacao_tipo_imovel",                  â”‚
â”‚   "slot": "tipo_imovel",                                           â”‚
â”‚   "valor_slot": "casa"                                             â”‚
â”‚ }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ATUALIZAÃ‡ÃƒO DE ESTADO                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ $intentAtual = "qualificacao_tipo_imovel"  â† Atualizado           â”‚
â”‚                                                                     â”‚
â”‚ $slotsAtuais = {                                                    â”‚
â”‚   "nome": "Lucas",                                                  â”‚
â”‚   "tipo_imovel": "Casa"  â† PREENCHIDO!                            â”‚
â”‚ }                                                                   â”‚
â”‚                                                                     â”‚
â”‚ Log:                                                                â”‚
â”‚ [VALIDACAO] Resposta contextual reconhecida                        â”‚
â”‚   estado: STATE_Q2_TIPO                                            â”‚
â”‚   resposta: Casa                                                   â”‚
â”‚   intent_sugerida: qualificacao_tipo_imovel                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. PROMPT PARA IA                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Prompt inclui:                                                      â”‚
â”‚                                                                     â”‚
â”‚ "Estado: STATE_Q2_TIPO                                             â”‚
â”‚  IntenÃ§Ã£o: qualificacao_tipo_imovel                               â”‚
â”‚  Slots: {"tipo_imovel": "Casa", ...}                              â”‚
â”‚                                                                     â”‚
â”‚  âš ï¸ IMPORTANTE: Neste estado, o usuÃ¡rio PODE responder com:       â”‚
â”‚     apartamento, casa, kitnet, comercial, terreno                 â”‚
â”‚  Se a resposta se encaixar, ACEITE e continue.                    â”‚
â”‚                                                                     â”‚
â”‚  Mensagem do cliente: Casa"                                        â”‚
â”‚                                                                     â”‚
â”‚ IA Processa... com contexto correto                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. RESPOSTA DA IA                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ "Perfeito! Casa Ã© uma Ã³tima escolha! ğŸ                            â”‚
â”‚                                                                     â”‚
â”‚  Deixe-me coletar alguns dados para encontrar as melhores opÃ§Ãµes..â”‚
â”‚                                                                     â”‚
â”‚  Quantos quartos vocÃª procura?"                                    â”‚
â”‚                                                                     â”‚
â”‚  [TransiÃ§Ã£o para STATE_Q3_QUARTOS]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. SAÃDA                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Resposta enviada ao cliente via WhatsApp                          â”‚
â”‚ Estado atualizado: thread.estado_atual = "STATE_Q3_QUARTOS"       â”‚
â”‚ Slots salvos: thread.slots = {tipo_imovel: "Casa", ...}           â”‚
â”‚ Logs registrados com todas as operaÃ§Ãµes                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Legenda de SÃ­mbolos

```
âœ… VÃ¡lido / Passou
âŒ InvÃ¡lido / Falhou
âš ï¸  AtenÃ§Ã£o / InformaÃ§Ã£o importante
â†’  Fluxo / PrÃ³ximo passo
â†“  ContinuaÃ§Ã£o
[  ]  Array / Lista
{}    Objeto / Mapa
''    String / Texto
```

---

Diagrama atualizado em: **13 de Janeiro de 2026**
