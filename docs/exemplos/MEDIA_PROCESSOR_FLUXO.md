# ğŸ“Š Fluxo Visual do Agente de Processamento de MÃ­dia

## Diagrama de Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WhatsApp (usuÃ¡rio)                          â”‚
â”‚              [envia imagem/PDF/documento/Ã¡udio]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Evolution API Gateway                         â”‚
â”‚         (webhook recebe em /api/webhook/whatsapp)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WhatsappWebhookController                          â”‚
â”‚         [valida integrantess e dispatch job]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ProcessWhatsappMessage Job (Queue)                    â”‚
â”‚          [orquestra fluxo de processamento]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                               â”‚
           â–¼                               â–¼
    [Texto?]                         [MÃ­dia?]
     â”‚ SIM                            â”‚ SIM
     â”‚                                â”‚
     â–¼                                â–¼
[Processamento                  processarMedia()
 de texto normal]                     â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚           â”‚           â”‚
                          â–¼           â–¼           â–¼
                       IMAGE        PDF        AUDIO
                          â”‚           â”‚           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚   â”‚   â”‚                â”‚
                â–¼                 â–¼   â–¼   â–¼                â–¼
           OpenAI Vision    spatie/pdf  DocumentProcessor  Armazenar
           API (anÃ¡lise)    -to-text    (DOCX/CSV/TXT)     (futuro:
                            (extraÃ§Ã£o)                      Whisper)
                â”‚                 â”‚           â”‚                â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚              â”‚
                         â–¼              â–¼
                  [ConteÃºdo extraÃ­do]
                    [Metadados]
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Armazenar em           â”‚
            â”‚ storage/app/public/    â”‚
            â”‚ whatsapp_media/        â”‚
            â”‚ - images/              â”‚
            â”‚ - documents/           â”‚
            â”‚ - audio/               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
              montarRespostaMedia()
              [cria resposta contextualizada]
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
      IMAGE           PDF/DOC          AUDIO
    "âœ… Imagem"    "âœ… Documento"   "âœ… Ãudio
     analisada      processado       recebido"
     com sucesso    com sucesso!
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                [Thread atualiza com
                 estado_historico]
                         â”‚
                         â–¼
              Evolution API (resposta)
              [envia mensagem processada]
                         â”‚
                         â–¼
              WhatsApp (usuÃ¡rio recebe)
                    resposta do bot
```

## Fluxo de Estados da MÃ­dia

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ARQUIVO RECEBIDO â”‚
                    â”‚   (evoluÃ§Ã£o)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ VALIDAR TIPO/TAMANHO    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                          â”‚
    VÃLIDO?                                    INVÃLIDO?
        â”‚ SIM                                      â”‚ NÃƒO
        â–¼                                          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TENTAR DOWNLOAD â”‚                     â”‚ REJEITAR COM â”‚
   â”‚ (HTTP timeout)  â”‚                     â”‚ ERRO CLARO   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
    â”‚ DOWNLOAD OK?   â”‚                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
            â”‚                                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                              â”‚
    â”‚ SIM      NÃƒO â”‚                              â”‚
    â–¼              â–¼                               â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
 â”‚ PROC â”‚     â”‚ RETORNARâ”‚                        â”‚
 â”‚ESSA  â”‚     â”‚ ERRO    â”‚                        â”‚
 â”‚TIPO  â”‚     â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚
 â””â”€â”€â”¬â”€â”€â”€â”˜        â”‚                               â”‚
    â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼                            â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â–¼
 â”‚ IMAGE?      â”‚         [RESPOSTA ERRO]
 â”‚ PDF?        â”‚                 â”‚
 â”‚ DOCUMENT?   â”‚                 â–¼
 â”‚ AUDIO?      â”‚         [ENVIADO AO BOT]
 â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”˜                 â”‚
    â”‚  â”‚  â”‚  â”‚                   â”‚
    â–¼  â–¼  â–¼  â–¼                   â”‚
 Vision|PDF|DOC|Audio            â”‚
 Analysis|Extract|Extract|Store  â”‚
    â”‚  â”‚  â”‚  â”‚                   â”‚
    â””â”€â”€â”¼â”€â”€â”¼â”€â”€â”˜                   â”‚
       â”‚                         â”‚
       â–¼                         â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   â”‚ EXTRAIDO    â”‚              â”‚
   â”‚ COM SUCESSO â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
          â”‚                     â”‚
          â–¼                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   â”‚ ARMAZENAR   â”‚              â”‚
   â”‚ LOCALMENTE  â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
          â”‚                     â”‚
          â–¼                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
   â”‚ MONTAR RESPOSTA  â”‚         â”‚
   â”‚ CONTEXTUALIZADA  â”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
          â”‚                     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
           [RESPOSTA ENVIADA PARA]
           [EVOLUTION API]
                     â”‚
                     â–¼
           [WHATSAPP ENTREGA]
           [AO USUÃRIO]
```

## Estados da Conversa com MÃ­dia

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FLUXO CONVERSACIONAL COM MÃDIA              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ESTADO 1: INICIAL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: "OlÃ¡! Como...â”‚
â”‚      posso ajudar?" â”‚
â”‚ (aguardando resposta)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [usuÃ¡rio envia IMAGEM de imÃ³vel]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MediaProcessor detecta: tipo_midia      â”‚
â”‚ = 'image'                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [OpenAI Vision analisa]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DescriÃ§Ã£o: "Sala moderna 3x4m,          â”‚
â”‚ sofÃ¡ cinza, piso em madeira clara,      â”‚
â”‚ iluminaÃ§Ã£o natural por 2 janelas..."    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [Bot responde]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: "âœ… Imagem analisada com sucesso!  â”‚
â”‚                                         â”‚
â”‚ Aqui estÃ¡ o que identifiquei:           â”‚
â”‚ â€¢ Sala moderna 3x4m                    â”‚
â”‚ â€¢ SofÃ¡ cinza estilo moderno            â”‚
â”‚ â€¢ Piso em madeira clara                â”‚
â”‚ â€¢ IluminaÃ§Ã£o natural por 2 janelas     â”‚
â”‚                                        â”‚
â”‚ Interessado em imÃ³veis com essas       â”‚
â”‚ caracterÃ­sticas?"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [usuÃ¡rio: "Sim, em SÃ£o Paulo"]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Continua fluxo normal com slots        â”‚
â”‚ objetivo, local, etc.]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ESTADO 2: COM DOCUMENTO
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: "Qual sua      â”‚
â”‚      faixa de valor?â”‚
â”‚ R$ 500-600k /       â”‚
â”‚ R$ 600-800k / etc"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [usuÃ¡rio envia PDF de contrato]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MediaProcessor detecta: tipo_midia      â”‚
â”‚ = 'pdf'                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [spatie/pdf-to-text extrai texto]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Texto extraÃ­do:                         â”‚
â”‚ "CONTRATO DE COMPRA...                 â”‚
â”‚  Valor: R$ 650.000,00                  â”‚
â”‚  LocalizaÃ§Ã£o: Morumbi, SP              â”‚
â”‚  CondiÃ§Ãµes: 50% na assinatura..."      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ [Bot responde]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bot: "âœ… PDF processado com sucesso!    â”‚
â”‚                                         â”‚
â”‚ Identifiquei:                           â”‚
â”‚ â€¢ Valor: R$ 650.000                    â”‚
â”‚ â€¢ Local: Morumbi, SP                   â”‚
â”‚ â€¢ Pagamento: 50% na assinatura         â”‚
â”‚ â€¢ Prazo: 360 meses                     â”‚
â”‚                                         â”‚
â”‚ Gostaria de anÃ¡lise de                 â”‚
â”‚ viabilidade financeira?"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Arquitetura de Armazenamento

```
storage/app/public/
â”‚
â””â”€â”€ whatsapp_media/
    â”œâ”€â”€ images/
    â”‚   â”œâ”€â”€ img_657a3b1c.jpg      (foto do imÃ³vel)
    â”‚   â”œâ”€â”€ img_657a3b2d.png      (documento visual)
    â”‚   â””â”€â”€ ...
    â”‚
    â”œâ”€â”€ documents/
    â”‚   â”œâ”€â”€ doc_657a3c1f.pdf      (contrato)
    â”‚   â”œâ”€â”€ doc_657a3c2g.docx     (proposta)
    â”‚   â”œâ”€â”€ doc_657a3c3h.xlsx     (orÃ§amento)
    â”‚   â”œâ”€â”€ doc_657a3c4i.txt      (anotaÃ§Ãµes)
    â”‚   â””â”€â”€ ...
    â”‚
    â””â”€â”€ audio/
        â”œâ”€â”€ audio_657a3d1j.ogg    (mensagem de voz)
        â”œâ”€â”€ audio_657a3d2k.mp3    (informaÃ§Ã£o)
        â””â”€â”€ ...

[Cada arquivo tem:]
- Nome Ãºnico (UUID-like)
- Metadados (tamanho, mime, url original)
- Timestamp de armazenamento
- ReferÃªncia em estado_historico do Thread
```

## IntegraÃ§Ã£o com State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   USUÃRIO ENVIA MIDIA            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ processarMedia()     â”‚
        â”‚                      â”‚
        â”‚ [MediaProcessor]     â”‚
        â”‚                      â”‚
        â”‚ - Valida tipo       â”‚
        â”‚ - Download          â”‚
        â”‚ - Processa          â”‚
        â”‚ - Armazena          â”‚
        â”‚ - Extrai conteÃºdo   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Thread.estado_atual  â”‚
        â”‚ (nÃ£o muda com mÃ­dia) â”‚
        â”‚                      â”‚
        â”‚ MantÃ©m estado       â”‚
        â”‚ original para       â”‚
        â”‚ continuar fluxo     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ montarRespostaMedia()â”‚
        â”‚                      â”‚
        â”‚ [cria mensagem]      â”‚
        â”‚ [contextualizada]    â”‚
        â”‚ [ao estado atual]    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Resposta enviada     â”‚
        â”‚ sem avanÃ§ar estado   â”‚
        â”‚                      â”‚
        â”‚ UsuÃ¡rio pode entÃ£o:  â”‚
        â”‚ - Continuar conversaâ”‚
        â”‚ - Enviar novo dado  â”‚
        â”‚ - Confirmar info    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Timeline de Processamento

```
t=0ms:     [WhatsApp envia arquivo]
           â†“
t=10ms:    [Webhook recebe]
           â†“
t=20ms:    [Job despachado]
           â†“
t=50ms:    [MediaProcessor instanciado]
           â†“
t=100ms:   [Download iniciado (HTTP GET)]
           â†“
t=500-2000ms: [Download concluÃ­do]
           â†“
t=2010ms:  [ValidaÃ§Ã£o tipo/tamanho]
           â†“
t=2020ms:  [Processamento especÃ­fico]
           â”œâ”€ Imagem: OpenAI Vision API (2-5s)
           â”œâ”€ PDF: spatie/pdf-to-text (1-2s)
           â”œâ”€ Documento: parsing XML (500-1000ms)
           â””â”€ Ãudio: apenas armazenamento (100ms)
           â†“
t=7000ms:  [Resultado pronto]
           â†“
t=7010ms:  [Armazenamento local]
           â†“
t=7030ms:  [Resposta montada]
           â†“
t=7050ms:  [Evolution API chamada]
           â†“
t=7100ms:  [WhatsApp entrega]
           â†“
t=7200ms:  [UsuÃ¡rio vÃª resposta]

[Total: ~7.2 segundos desde envio atÃ© recebimento]
```

---

**Nota**: Os timestamps sÃ£o estimados e variam conforme:
- Tamanho do arquivo
- Velocidade de internet
- Carga da OpenAI API
- ConfiguraÃ§Ã£o do servidor
